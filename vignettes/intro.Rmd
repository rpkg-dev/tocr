---
title: "An introduction to the **tocr** package:"
subtitle: "Adding/updating/removing TOCs to/from (R) Markdown documents"
author: "Salim Brüggemann"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
editor_options:
  chunk_output_type: console
vignette: >
  %\VignetteIndexEntry{An introduction to the **tocr** package}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, setup, include = FALSE}
# set global knitr options
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

# set global R options
options(digits = 5L,
        scipen = 999L)
```

Note that the following examples use [magrittr's piping operators](http://magrittr.tidyverse.org/). Therefore we have to load and attach the `magrittr` package before running any of the subsequent code:

```{r}
library(magrittr)
```


## Add a fresh TOC to an (R) Markdown document

Adding a table of contents (TOC) to the [pdftools](https://github.com/ropensci/pdftools) `README.md` for example is as simple as:

```{r}
tocr::add_toc(md = "https://raw.githubusercontent.com/ropensci/pdftools/e7248d9956c7e73968628fa3a8ed37f0a8c23b37/README.md")
```

The parameter `md` can specify a single file path, a single URL or a character vector (one string per line).


## Update an existing TOC of an (R) Markdown document

To demonstrate updating an existing TOC, I will use the [doctoc README file](https://github.com/thlorenz/doctoc/blob/master/README.md) which already includes a TOC generated by doctoc. `add_toc()` recognizes this TOC properly. If you find software-generated Markdown TOCs which aren't recognized by `add_toc()`, please [file an issue](http://gitlab.com/salim_b/r/pkgs/tocr/issues).

Now let's use the doctoc README as it appeared live at the end of May 2018[^doctoc-effective], replace/update its TOC with a different one generated by `add_toc()` and display the first 41 lines:

```{r}
"https://raw.githubusercontent.com/thlorenz/doctoc/1d386261972d35c6bcd187d0a00e666f9d893d8d/README.md" %>%
  tocr::add_toc(position = 33L,
                backlink_strings = c("\U1F446", "\U1F447"),
                listing_style = "*") %>%
  magrittr::extract(1L:41L) %>%
  cat(sep = "\n")
```

This removes the existing TOC and writes a new one which differs in the following characteristics:

- The new TOC is placed at line 33 (line numbers counted as in the original document).
- The new TOC uses `*`, not `-` as the symbol to list the TOC entries (they are semantically the same).
- There are backlinks to the new TOC before all headers included in the TOC for easier navigation. The backlink text consists of a `\U1F446` or `\U1F447` symbol depending on the header's position. If it is below the new TOC, the first symbol gets used, otherwise the second one.


[^doctoc-effective]: Effective [May 31, 2018](https://github.com/thlorenz/doctoc/blob/1d386261972d35c6bcd187d0a00e666f9d893d8d/README.md).


## Remove a TOC from an (R) Markdown document

Let's use the doctoc README file [from before](#updating_an_existing_toc_of_an_r_markdown_document) and remove it's TOC:

```{r}
tocr::remove_toc("https://raw.githubusercontent.com/thlorenz/doctoc/1d386261972d35c6bcd187d0a00e666f9d893d8d/README.md") %>%
  cat(sep = "\n")
```

Optionally you can specify an `old_toc_id` to [remove leftover backlinks](#remove_leftover_backlinks).

Note that `remove_toc()` is just a convenience wrapper function around `add_toc(..., position = "none")`.
   
### Remove backlinks only

To just remove the backlinks from a Markdown document, set the parameter `add_backlinks = FALSE` and leave all the other parameters untouched (except for a manually set `position` line number which might have to be adapted to factor in the TOC lines). For example:

```{r}
"https://raw.githubusercontent.com/tidyverse/purrr/d0a808186e820fb637affe4d92cef2c7bf3cf6bd/README.md" %>%
  # add TOC _and_ backlinks 
  tocr::add_toc(position = "below") %>%
  # only add TOC, remove possibly existing backlinks
  tocr::add_toc(position = "below",
                add_backlinks = FALSE)
```

### Remove leftover backlinks to custom HTML anchor/`<id>` attribute

Consider you have added a TOC to a Markdown document using a non-header style `title_tier` (like `"bold"`) and a strange `toc_id` like `"navigation_centre"`. Now just feeding that document to `add_toc()` or `remove_toc()` will ... not remove? remove?


## Particular TOC features

In the following, the effects of setting specific parameters of the `add_toc()` function are explained in more detail.

### TOC minimum and maximum tiers to include

The parameters `min_tier` and `max_tier` define which of all the possible header tiers `<h1>` – `<h6>` are considered in the TOC. By default, `<h1>` is not considered because it usually serves as the title of the document and it wouldn't make sense to include that in a TOC. But if your Markdown document deviates from this premise, you might wanna set `min_tier` by hand. The [Fira Code](https://github.com/tonsky/FiraCode) `README.md` for example doesn't include any `<h1>` headers[^firacode_effective], instead the title is formatted as `<h2>`. Therefore we wanna set `min_tier = 3` to obtain a reasonable TOC:

```{r}
tocr::add_toc(md = "https://raw.githubusercontent.com/tonsky/FiraCode/30862e05b00f41c9179a9424e382755a5ef954f0/README.md",
              min_tier = 3L) %>%
  magrittr::extract(1L:25L) %>%
  cat(sep = "\n")
```

The same way you can restrict the maximum tier to be included in the TOC. If we don't want to mention anything below tier `<h3>` for example, we set `max_tier = 3`:

```{r}
tocr::add_toc(md = "https://raw.githubusercontent.com/tonsky/FiraCode/30862e05b00f41c9179a9424e382755a5ef954f0/README.md",
              min_tier = 3) %>%
  magrittr::extract(1:25) %>%
  cat(sep = "\n")
```


[^firacode_effective]: Effective [May 31, 2018](https://github.com/tonsky/FiraCode/blob/30862e05b00f41c9179a9424e382755a5ef954f0/README.md).


### TOC positioning

Where to place the TOC including its surrounding `TOC BEGIN` and `"TOC END` comments is defined by the `position` argument. It can either be:

- `"top"` to place the TOC at the very beginning of the document, i.e. line 1.
- `"bottom"` to place the TOC at the very end of the document.
- `"above"` to place the TOC _above_ the lines between the uppermost header of tier <= `min_tier` and the next header above (if any).
- `"below"` to place the TOC _below_ the lines between the uppermost header of tier <= `min_tier` and the next header above (if any), i.e. right above the uppermost header of tier <= `min_tier`.
- `"none"` to only remove an existing TOC.
- A line number as a positive integer to insert the TOC right above this line.

#### Difference between `above` and `below`

...

```{r}
"https://raw.githubusercontent.com/mkearney/rtweet/ff5ac6cf48f63f0685beda6d5fed03388c51b7f2/README.md"
```

### TOC `listing_style`

There are three possible ways to list the TOC entries and the parameter `listing_style` defines which one it is. Possible are:

- An _unordered_ Markdown list. Set `listing_style` to `-` or `*` for the respective listing symbols.

- An _ordered_ Markdown list. Set `listing_style = "ordered"` for this.

- Just plain text indented by non-breaking spaces (`&nbsp;`) according to the hierarchy of the headers. Set `listing_style = "indented"` for this.

While the first two options seem aesthetically superior, the last one is particularly useful in two situations:

1. Consider a Markdown document with numbered headers like `# 1. Introduction`. 

2. Consider a Markdown document with a strange header hierarchy... 

   **Notice:** `add_toc()` checks if the first TOC entry is of the lowest tier included in the TOC, and if not, automatically sets `listing_style = "indented"` to avoid a broken Markdown list (when it happens, a warning message will printed about it).

### TOC `markdown_flavor`

...
